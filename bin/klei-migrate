#!/usr/bin/env node

/**
 * This is a SUPER-WORK-IN-PROGRESS...
 * Almost not ready at all, but soon.
 */
var migrate = require('../.');


// Optimist argument handling
var argv = require('optimist')
    .boolean(['up', 'down', 'one', 'status'])
    .argv;

//Cli colouring
var clc = require('cli-color'), 
    info = clc.blackBright,
    error = clc.red,
    ok = clc.green,
    commands = clc.greenBright,
    switches = clc.blueBright,
    arguments = clc.cyanBright;
 

var c = argv._.splice(0,1)[0]
switch (c) {
    case 'new':
    case 'create':
        migrate.create(argv._.join(' '), function (err, name) {
            if (err) {
                console.error(err);
            } else {
                console.log(ok('Migration: "' + name + '" created!'));
            }
        });
        break;
    case 'run':
        var direction = argv.down ? 'up' : 'down';
            one = argv.one
            dry = argv.dry
            name = argv._.join();

        if (name && name.indexOf('-') === 0) {
            name = null;
        }

        migrate.direction(direction);

        if (one) {
            migrate.limit(1);
        }

        if (dry) {
            migrate.dry(name, function (migratable) {
                console.log(info('Migrating' + " " + migrate.direction() + ":"));
                console.log(info(migratable));
            });
        } else {
            migrate.run(name, function (err, migrated) {
                if (migrated.length) {
                    console.log(info('Migrated:', migrated));
                }
                if (err) {
                    console.error(error('Run failed!'));
                    console.error(info(err.stack));
                    process.exit(1);
                } else {
                    console.log(ok('All migrations run.'));
                }
            });
        }
        break;
    default:
        console.log("Usage: klei-migrate " + commands("<command>") + " " + switches("[swithces]") + " " + arguments("(arguments)") );
        console.log();
        console.log("   " + commands("new") + " " + arguments("(migration name)"));
        console.log();  
        console.log("   " + commands("run") + " " + switches("[switches]"));
        console.log("       " + switches("--up"))
        console.log("       " + switches("--down"))
        console.log("       " + switches("--one") + "       " +info("Run only one migration up/down"));
        console.log("       " + switches("--status") + "    " + info("Lists what is going to be migrated"));
        console.log();
        break;

}
